# å®Ÿè£…ãƒ«ãƒ¼ãƒ«ãƒ»ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«å‰‡ã£ãŸå®Ÿè£…ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚

---

## ğŸ“‹ ç›®æ¬¡

1. [ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆãƒ«ãƒ¼ãƒ«](#ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆãƒ«ãƒ¼ãƒ«)
2. [å±¤ã”ã¨ã®å®Ÿè£…ãƒ«ãƒ¼ãƒ«](#å±¤ã”ã¨ã®å®Ÿè£…ãƒ«ãƒ¼ãƒ«)
3. [ä¾å­˜æ€§æ³¨å…¥ï¼ˆDIï¼‰ã®ãƒ«ãƒ¼ãƒ«](#ä¾å­˜æ€§æ³¨å…¥diã®ãƒ«ãƒ¼ãƒ«)
4. [å‘½åè¦å‰‡](#å‘½åè¦å‰‡)
5. [ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„](#ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„)
6. [ç¦æ­¢äº‹é …](#ç¦æ­¢äº‹é …)

---

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆãƒ«ãƒ¼ãƒ«

### æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ

æ–°ã—ã„æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹éš›ã¯ã€ä»¥ä¸‹ã®æ§‹é€ ã‚’å¿…ãšå®ˆã‚‹ã“ã¨ï¼š

```
lib/features/<feature_name>/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entities/      # ãƒ“ã‚¸ãƒã‚¹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”‚   â”œâ”€â”€ repositories/  # Repository ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
â”‚   â””â”€â”€ usecases/      # UseCase
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ models/        # DTOs (json_serializable)
â”‚   â”œâ”€â”€ datasources/   # DataSource (API, DB)
â”‚   â””â”€â”€ repositories/  # Repository å®Ÿè£…
â””â”€â”€ presentation/
    â”œâ”€â”€ view_models/   # ViewModel (Riverpod Notifier)
    â””â”€â”€ views/         # View (Widget)
```

### å…±æœ‰æ©Ÿèƒ½ã®é…ç½®

è¤‡æ•°ã® Feature ã§ä½¿ç”¨ã™ã‚‹æ©Ÿèƒ½ã¯ `shared/` ã«é…ç½®ï¼š

```
lib/shared/<feature_name>/
â”œâ”€â”€ domain/
â”œâ”€â”€ data/
â””â”€â”€ presentation/
    â””â”€â”€ widgets/  # å…±æœ‰ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
```

### æŠ€è¡“çš„ã‚¤ãƒ³ãƒ•ãƒ©ã®é…ç½®

æŠ€è¡“çš„ãªè¨­å®šã‚„ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã¯ `core/` ã«é…ç½®ï¼š

```
lib/core/
â”œâ”€â”€ di/       # ä¾å­˜æ€§æ³¨å…¥
â”œâ”€â”€ network/  # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š
â”œâ”€â”€ router/   # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
â”œâ”€â”€ theme/    # ãƒ†ãƒ¼ãƒ
â””â”€â”€ utils/    # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
```

---

## å±¤ã”ã¨ã®å®Ÿè£…ãƒ«ãƒ¼ãƒ«

### Domain å±¤ã®ãƒ«ãƒ¼ãƒ«

#### âœ… ã‚„ã‚‹ã¹ãã“ã¨

1. **ç´”ç²‹ãª Dart ã‚³ãƒ¼ãƒ‰ã®ã¿ä½¿ç”¨**

   - Flutter SDK ã‚„å¤–éƒ¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ä¾å­˜ã—ãªã„
   - ä¾‹å¤–: Dart ã®æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ OK

2. **Entity ã¯ä¸å¤‰ï¼ˆImmutableï¼‰ã«ã™ã‚‹**

   ```dart
   class Pokemon {
     final int id;
     final String name;

     const Pokemon({
       required this.id,
       required this.name,
     });
   }
   ```

3. **Repository ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆabstract classï¼‰ã¨ã—ã¦å®šç¾©**

   ```dart
   abstract class PokemonRepository {
     Future<List<PokemonListItem>> getPokemonList({
       required int limit,
       required int offset,
     });

     Future<Pokemon> getPokemonDetail(int id);
   }
   ```

4. **UseCase ã¯å˜ä¸€è²¬ä»»ã®åŸå‰‡ã«å¾“ã†**

   - 1 ã¤ã® UseCase ã¯ 1 ã¤ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿ã‚’æ‹…å½“
   - `call()` ãƒ¡ã‚½ãƒƒãƒ‰ã§å®Ÿè£…

   ```dart
   class GetPokemonListUseCase {
     final PokemonRepository repository;

     GetPokemonListUseCase(this.repository);

     Future<List<PokemonListItem>> call({
       required int limit,
       required int offset,
     }) async {
       return await repository.getPokemonList(
         limit: limit,
         offset: offset,
       );
     }
   }
   ```

#### âŒ ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨

- âŒ Flutter SDKï¼ˆ`import 'package:flutter/...'`ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹
- âŒ å¤–éƒ¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆDioã€Retrofit ç­‰ï¼‰ã«ä¾å­˜ã™ã‚‹
- âŒ UI ã«é–¢ã™ã‚‹å‡¦ç†ã‚’æ›¸ã
- âŒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãƒ»ä¿å­˜ã®å…·ä½“çš„ãªå®Ÿè£…ã‚’æ›¸ã

---

### Data å±¤ã®ãƒ«ãƒ¼ãƒ«

#### âœ… ã‚„ã‚‹ã¹ãã“ã¨

1. **Model ã¯ DTO ã¨ã—ã¦æ‰±ã†**

   - JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³å°‚ç”¨
   - `@JsonSerializable()` ã‚’ä½¿ç”¨

   ```dart
   @JsonSerializable()
   class PokemonDetailResponse {
     final int id;
     final String name;
     final int height;
     final int weight;

     PokemonDetailResponse({
       required this.id,
       required this.name,
       required this.height,
       required this.weight,
     });

     factory PokemonDetailResponse.fromJson(Map<String, dynamic> json) =>
         _$PokemonDetailResponseFromJson(json);

     Map<String, dynamic> toJson() => _$PokemonDetailResponseToJson(this);
   }
   ```

2. **Repository å®Ÿè£…ã¯ Domain ã® Repository ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ implements**

   ```dart
   class PokemonRepositoryImpl implements PokemonRepository {
     final PokemonApiClient apiClient;

     PokemonRepositoryImpl(this.apiClient);

     @override
     Future<Pokemon> getPokemonDetail(int id) async {
       final response = await apiClient.getPokemonDetail(id);
       return _responseToEntity(response);
     }

     // DTO â†’ Entity ã®å¤‰æ›
     Pokemon _responseToEntity(PokemonDetailResponse dto) {
       return Pokemon(
         id: dto.id,
         name: dto.name,
         // ... ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
       );
     }
   }
   ```

3. **DataSource ã¯å…·ä½“çš„ãªæŠ€è¡“ã«ä¾å­˜ã—ã¦ OK**

   - Retrofitã€Dioã€SharedPreferences ãªã©

   ```dart
   @RestApi(baseUrl: 'https://pokeapi.co/api/v2')
   abstract class PokemonApiClient {
     factory PokemonApiClient(Dio dio) = _PokemonApiClient;

     @GET('/pokemon')
     Future<PokemonListResponse> getPokemonList(
       @Query('limit') int limit,
       @Query('offset') int offset,
     );
   }
   ```

#### âŒ ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨

- âŒ Domain å±¤ã® Entity ã‚’ç›´æ¥ JSON ã«å¤‰æ›ã™ã‚‹
- âŒ ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ãï¼ˆãã‚Œã¯ UseCase ã®å½¹å‰²ï¼‰
- âŒ UI ã«é–¢ã™ã‚‹å‡¦ç†ã‚’æ›¸ã

---

### Presentation å±¤ã®ãƒ«ãƒ¼ãƒ«

#### âœ… ã‚„ã‚‹ã¹ãã“ã¨

1. **ViewModel ã¯ Riverpod Notifier ã§å®Ÿè£…**

   - `@riverpod` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
   - çŠ¶æ…‹ç®¡ç†ã¯ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãª State ã‚¯ãƒ©ã‚¹

   ```dart
   @riverpod
   class PokemonListViewModel extends _$PokemonListViewModel {
     late final GetPokemonListUseCase _useCase;

     @override
     PokemonListState build() {
       _useCase = ref.watch(getPokemonListUseCaseProvider);
       Future.microtask(() => loadInitialPokemons());
       return const PokemonListState(hasMore: true);
     }

     Future<void> loadInitialPokemons() async {
       state = state.copyWith(isLoading: true);
       try {
         final pokemons = await _useCase(limit: 20, offset: 0);
         state = state.copyWith(
           pokemons: pokemons,
           isLoading: false,
         );
       } catch (e) {
         state = state.copyWith(
           isLoading: false,
           errorMessage: 'ã‚¨ãƒ©ãƒ¼: $e',
         );
       }
     }
   }
   ```

2. **State ã‚¯ãƒ©ã‚¹ã¯ `copyWith` ã‚’å®Ÿè£…**

   ```dart
   class PokemonListState {
     final List<PokemonListItem> pokemons;
     final bool isLoading;
     final String? errorMessage;

     const PokemonListState({
       this.pokemons = const [],
       this.isLoading = false,
       this.errorMessage,
     });

     PokemonListState copyWith({
       List<PokemonListItem>? pokemons,
       bool? isLoading,
       String? errorMessage,
     }) {
       return PokemonListState(
         pokemons: pokemons ?? this.pokemons,
         isLoading: isLoading ?? this.isLoading,
         errorMessage: errorMessage ?? this.errorMessage,
       );
     }
   }
   ```

3. **View ã¯ ConsumerWidget ã¾ãŸã¯ HookConsumerWidget**

   ```dart
   class PokemonListView extends HookConsumerWidget {
     const PokemonListView({super.key});

     @override
     Widget build(BuildContext context, WidgetRef ref) {
       final state = ref.watch(pokemonListViewModelProvider);
       final viewModel = ref.read(pokemonListViewModelProvider.notifier);

       // UI ã®å®Ÿè£…
     }
   }
   ```

#### âŒ ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨

- âŒ ViewModel ã«ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ãï¼ˆUseCase ã‚’ä½¿ã†ï¼‰
- âŒ View ã‹ã‚‰ç›´æ¥ Repository ã‚„ DataSource ã‚’å‘¼ã¶
- âŒ ViewModel ã§ç›´æ¥ API ã‚’å‘¼ã¶
- âŒ State ã‚’ç›´æ¥å¤‰æ›´ã™ã‚‹ï¼ˆå¿…ãš `copyWith` ã‚’ä½¿ã†ï¼‰

---

## ä¾å­˜æ€§æ³¨å…¥ï¼ˆDIï¼‰ã®ãƒ«ãƒ¼ãƒ«

### DI ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®

å…¨ã¦ã® DI è¨­å®šã¯ `lib/core/di/` ã«é›†ç´„ï¼š

```dart
// lib/core/di/pokemon_di.dart
@riverpod
PokemonApiClient pokemonApiClient(Ref ref) {
  final dio = ref.watch(dioProvider);
  return PokemonApiClient(dio);
}

@riverpod
PokemonRepository pokemonRepository(Ref ref) {
  final apiClient = ref.watch(pokemonApiClientProvider);
  return PokemonRepositoryImpl(apiClient);
}

@riverpod
GetPokemonListUseCase getPokemonListUseCase(Ref ref) {
  final repository = ref.watch(pokemonRepositoryProvider);
  return GetPokemonListUseCase(repository);
}
```

### DI ã®ä¾å­˜é–¢ä¿‚

```
Dio â†’ DataSource â†’ Repository â†’ UseCase â†’ ViewModel
```

å„å±¤ã¯ 1 ã¤ä¸‹ã®å±¤ã®ã¿ã«ä¾å­˜ã™ã‚‹ã€‚

---

## å‘½åè¦å‰‡

### ãƒ•ã‚¡ã‚¤ãƒ«å

- **ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹** ã‚’ä½¿ç”¨
- ä¾‹: `pokemon_list_view.dart`, `get_pokemon_list_usecase.dart`

### ã‚¯ãƒ©ã‚¹å

| ç¨®é¡                 | å‘½åè¦å‰‡                       | ä¾‹                                        |
| -------------------- | ------------------------------ | ----------------------------------------- |
| Entity               | åè©                           | `Pokemon`, `User`                         |
| Repository Interface | `<Entity>Repository`           | `PokemonRepository`                       |
| Repository Impl      | `<Entity>RepositoryImpl`       | `PokemonRepositoryImpl`                   |
| UseCase              | `<å‹•è©><å¯¾è±¡>UseCase`          | `GetPokemonListUseCase`                   |
| DataSource           | `<Entity><ç¨®é¡>DataSource`     | `PokemonApiClient`, `UserLocalDataSource` |
| Model (DTO)          | `<Entity><ç¨®é¡>Response/Model` | `PokemonDetailResponse`                   |
| ViewModel            | `<Feature>ViewModel`           | `PokemonListViewModel`                    |
| View                 | `<Feature>View`                | `PokemonListView`                         |
| State                | `<Feature>State`               | `PokemonListState`                        |

---

## ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„

### Import ã®é †åº

1. Dart SDK
2. Flutter SDK
3. å¤–éƒ¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
4. è‡ªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

```dart
import 'dart:async';

import 'package:flutter/material.dart';

import 'package:riverpod_annotation/riverpod_annotation.dart';
import 'package:dio/dio.dart';

import 'package:work/core/di/pokemon_di.dart';
import 'package:work/features/pokemon/domain/entities/pokemon.dart';
```

### ã‚³ãƒ¡ãƒ³ãƒˆ

- ã‚¯ãƒ©ã‚¹ã«ã¯å¿…ãšãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ`///`ï¼‰ã‚’æ›¸ã
- è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã«ã¯èª¬æ˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã

```dart
/// ãƒã‚±ãƒ¢ãƒ³ä¸€è¦§å–å¾—UseCase
///
/// PokÃ©API ã‹ã‚‰ãƒã‚±ãƒ¢ãƒ³ã®ä¸€è¦§ã‚’å–å¾—ã—ã¾ã™ã€‚
/// ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚
class GetPokemonListUseCase {
  // ...
}
```

### ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¿…ãšã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’å®Ÿè¡Œï¼š

```bash
fvm flutter pub run build_runner build --delete-conflicting-outputs
```

- `@JsonSerializable()` ã‚’ä½¿ã£ãŸ Model
- `@riverpod` ã‚’ä½¿ã£ãŸ Provider
- `@RestApi()` ã‚’ä½¿ã£ãŸ API Client

---

## ç¦æ­¢äº‹é …

### ğŸš« çµ¶å¯¾ã«ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨

1. **å±¤ã‚’ã¾ãŸã„ã ä¾å­˜**

   - âŒ Domain å±¤ã‹ã‚‰ Data å±¤ã‚„ Presentation å±¤ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
   - âŒ UseCase ã‹ã‚‰ ViewModel ã‚’å‘¼ã¶

2. **å¾ªç’°å‚ç…§**

   - âŒ A ãŒ B ã«ä¾å­˜ã—ã€B ãŒ A ã«ä¾å­˜ã™ã‚‹

3. **ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®ä½¿ç”¨**

   - âŒ `static` ãªã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ

4. **ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°**

   - âŒ URL ã‚„ã‚­ãƒ¼ã‚’ç›´æ¥ã‚³ãƒ¼ãƒ‰ã«æ›¸ã
   - âœ… ç’°å¢ƒå¤‰æ•°ã‚„å®šæ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨

5. **å·¨å¤§ãªãƒ•ã‚¡ã‚¤ãƒ«**

   - âŒ 1 ãƒ•ã‚¡ã‚¤ãƒ«ã«è¤‡æ•°ã®è²¬å‹™ã‚’æŒã¤ã‚¯ãƒ©ã‚¹ã‚’è©°ã‚è¾¼ã‚€
   - âœ… 1 ãƒ•ã‚¡ã‚¤ãƒ« = 1 ã‚¯ãƒ©ã‚¹ï¼ˆState ã‚¯ãƒ©ã‚¹ã¯ä¾‹å¤–ï¼‰

6. **ç›´æ¥çš„ãª null è¿”å´**
   - âŒ `null` ã‚’è¿”ã™ãƒ¡ã‚½ãƒƒãƒ‰
   - âœ… `<Type>?` ã§ nullable å‹ã‚’æ˜ç¤º

---

## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

æ–°æ©Ÿèƒ½å®Ÿè£…æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼š

- [ ] Domain å±¤ã¯ç´”ç²‹ãª Dart ã‚³ãƒ¼ãƒ‰ã®ã¿ã‹ï¼Ÿ
- [ ] Repository ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©ã—ãŸã‹ï¼Ÿ
- [ ] UseCase ã¯å˜ä¸€è²¬ä»»ã‹ï¼Ÿ
- [ ] Model ã« `@JsonSerializable()` ã‚’ä»˜ã‘ãŸã‹ï¼Ÿ
- [ ] Repository å®Ÿè£…ã¯ DTO â†’ Entity å¤‰æ›ã—ã¦ã„ã‚‹ã‹ï¼Ÿ
- [ ] ViewModel ã¯ Riverpod Notifier ã§å®Ÿè£…ã—ãŸã‹ï¼Ÿ
- [ ] State ã‚¯ãƒ©ã‚¹ã« `copyWith` ã‚’å®Ÿè£…ã—ãŸã‹ï¼Ÿ
- [ ] DI è¨­å®šã‚’ `core/di/` ã«è¿½åŠ ã—ãŸã‹ï¼Ÿ
- [ ] ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’å®Ÿè¡Œã—ãŸã‹ï¼Ÿ
- [ ] `flutter analyze` ã§ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ï¼Ÿ

---

## å‚è€ƒè³‡æ–™

- [Clean Architecture (Uncle Bob)](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
- [Flutter Clean Architecture Tutorial (Reso Coder)](https://resocoder.com/flutter-clean-architecture-tdd/)
- [Riverpod Documentation](https://riverpod.dev/)
