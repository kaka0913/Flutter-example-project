# å®Ÿè£…ãƒ«ãƒ¼ãƒ«ãƒ»ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã€Œã‚·ãƒ³ãƒ—ãƒ«ãª Feature-First + Repositoryã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«å‰‡ã£ãŸå®Ÿè£…ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚

---

## ğŸ“‹ ç›®æ¬¡

1. [ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆãƒ«ãƒ¼ãƒ«](#ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆãƒ«ãƒ¼ãƒ«)
2. [å±¤ã”ã¨ã®å®Ÿè£…ãƒ«ãƒ¼ãƒ«](#å±¤ã”ã¨ã®å®Ÿè£…ãƒ«ãƒ¼ãƒ«)
3. [ä¾å­˜æ€§æ³¨å…¥ï¼ˆDIï¼‰ã®ãƒ«ãƒ¼ãƒ«](#ä¾å­˜æ€§æ³¨å…¥diã®ãƒ«ãƒ¼ãƒ«)
4. [å‘½åè¦å‰‡](#å‘½åè¦å‰‡)
5. [ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„](#ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„)
6. [ç¦æ­¢äº‹é …](#ç¦æ­¢äº‹é …)
7. [ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)

---

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆãƒ«ãƒ¼ãƒ«

### æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ

æ–°ã—ã„æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹éš›ã¯ã€ä»¥ä¸‹ã®æ§‹é€ ã‚’å¿…ãšå®ˆã‚‹ã“ã¨ï¼š

```
lib/features/<feature_name>/
â”œâ”€â”€ datasources/             # ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼ˆAPI/DB/SharedPreferencesï¼‰
â”‚   â””â”€â”€ <feature>_data_source.dart
â”œâ”€â”€ dto/                     # ãƒ‡ãƒ¼ã‚¿è»¢é€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆAPIé€šä¿¡ç”¨ï¼‰
â”‚   â”œâ”€â”€ <model>_dto.dart
â”‚   â””â”€â”€ <model>_dto.g.dart   # è‡ªå‹•ç”Ÿæˆ
â”œâ”€â”€ entities/                # ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆãƒ“ãƒ¥ãƒ¼ç”¨ãƒ¢ãƒ‡ãƒ«ï¼‰
â”‚   â””â”€â”€ <model>_entity.dart
â”œâ”€â”€ presentation/            # ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤
â”‚   â”œâ”€â”€ <feature>_view.dart
â”‚   â””â”€â”€ <feature>_view_model.dart
â””â”€â”€ <feature>_repository.dart # ãƒªãƒã‚¸ãƒˆãƒª
```

**ä¾‹: Pokemonæ©Ÿèƒ½**
```
lib/features/pokemon/
â”œâ”€â”€ datasources/
â”‚   â””â”€â”€ pokemon_data_source.dart        # PokemonApiClient (Retrofit)
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ pokemon_detail_dto.dart
â”‚   â”œâ”€â”€ pokemon_detail_dto.g.dart
â”‚   â”œâ”€â”€ pokemon_list_dto.dart
â”‚   â””â”€â”€ pokemon_list_dto.g.dart
â”œâ”€â”€ entities/
â”‚   â”œâ”€â”€ pokemon_entity.dart
â”‚   â””â”€â”€ pokemon_list_item_entity.dart
â”œâ”€â”€ presentation/
â”‚   â”œâ”€â”€ pokemon_list_view.dart
â”‚   â”œâ”€â”€ pokemon_list_view_model.dart
â”‚   â”œâ”€â”€ pokemon_detail_view.dart
â”‚   â””â”€â”€ pokemon_detail_view_model.dart
â””â”€â”€ pokemon_repository.dart
```

### å…±æœ‰æ©Ÿèƒ½ã®é…ç½®

è¤‡æ•°ã® Feature ã§ä½¿ç”¨ã™ã‚‹æ©Ÿèƒ½ã¯ `shared/` ã«é…ç½®ï¼š

```
lib/shared/<feature_name>/
â”œâ”€â”€ datasources/          # ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
â”œâ”€â”€ entities/             # ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”œâ”€â”€ presentation/
â”‚   â””â”€â”€ widgets/          # å…±æœ‰ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
â””â”€â”€ <feature>_repository.dart
```

**ä¾‹: Authæ©Ÿèƒ½**
```
lib/shared/auth/
â”œâ”€â”€ datasources/
â”‚   â””â”€â”€ user_data_source.dart
â”œâ”€â”€ entities/
â”‚   â””â”€â”€ user_entity.dart
â”œâ”€â”€ presentation/
â”‚   â””â”€â”€ widgets/
â”‚       â””â”€â”€ user_switcher.dart
â””â”€â”€ user_repository.dart
```

### æŠ€è¡“çš„ã‚¤ãƒ³ãƒ•ãƒ©ã®é…ç½®

æŠ€è¡“çš„ãªè¨­å®šã‚„ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã¯ `core/` ã«é…ç½®ï¼š

```
lib/core/
â”œâ”€â”€ di/       # ä¾å­˜æ€§æ³¨å…¥ï¼ˆDIï¼‰ã®ä¸­å¤®ç®¡ç†
â”œâ”€â”€ network/  # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šï¼ˆDioï¼‰
â”œâ”€â”€ router/   # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆgo_routerï¼‰
â”œâ”€â”€ theme/    # ãƒ†ãƒ¼ãƒè¨­å®š
â””â”€â”€ utils/    # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
```

---

## å±¤ã”ã¨ã®å®Ÿè£…ãƒ«ãƒ¼ãƒ«

### DataSource å±¤ã®ãƒ«ãƒ¼ãƒ«

#### âœ… ã‚„ã‚‹ã¹ãã“ã¨

1. **API/DB/SharedPreferencesã¨ã®ã‚„ã‚Šå–ã‚Šã‚’æ‹…å½“**

   - å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã¨ã®é€šä¿¡ã®ã¿ã‚’æ‹…å½“
   - DTOã®ç”Ÿæˆãƒ»ãƒ‘ãƒ¼ã‚¹ã‚’å®Ÿæ–½
   - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯æ›¸ã‹ãªã„

2. **åŸºæœ¬çš„ã«remote/localã§åˆ†ã‘ãªã„**

   - 1ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‹
   - ä¾‹å¤–: è²¬å‹™ãŒæ˜ç¢ºã«åˆ†ã‹ã‚Œã¦ã„ã‚‹å ´åˆã¯åˆ†å‰²å¯èƒ½

   ```dart
   // pokemon_data_source.dart
   @RestApi(baseUrl: 'https://pokeapi.co/api/v2/')
   abstract class PokemonDataSource {
     factory PokemonDataSource(Dio dio) = _PokemonDataSource;

     @GET('/pokemon')
     Future<PokemonListDto> getPokemonList(
       @Query('limit') int limit,
       @Query('offset') int offset,
     );

     @GET('/pokemon/{id}')
     Future<PokemonDetailDto> getPokemonDetail(@Path('id') int id);
   }
   ```

3. **åˆ†å‰²ãŒå¿…è¦ãªå ´åˆã®ä¾‹**

   ```dart
   // survey_local_data_source.dart
   class SurveyLocalDataSource {
     final SharedPreferences _prefs;

     SurveyLocalDataSource(this._prefs);

     Future<SurveyAnswerDto?> getSavedAnswer() async {
       final json = _prefs.getString('survey_answer');
       if (json == null) return null;
       return SurveyAnswerDto.fromJson(jsonDecode(json));
     }

     Future<void> saveAnswer(SurveyAnswerDto dto) async {
       await _prefs.setString('survey_answer', jsonEncode(dto.toJson()));
     }
   }

   // survey_remote_data_source.dart
   class SurveyRemoteDataSource {
     final Dio _dio;

     SurveyRemoteDataSource(this._dio);

     Future<RecommendationDto> getRecommendation(SurveyAnswerDto dto) async {
       final response = await _dio.post('/recommendation', data: dto.toJson());
       return RecommendationDto.fromJson(response.data);
     }
   }
   ```

#### âŒ ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨

- âŒ ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ãï¼ˆRepository ã®å½¹å‰²ï¼‰
- âŒ Entity ã‚’ç›´æ¥æ‰±ã†ï¼ˆDTOã®ã¿ã‚’ä½¿ç”¨ï¼‰
- âŒ UI ã«é–¢ã™ã‚‹å‡¦ç†ã‚’æ›¸ã

---

### DTO å±¤ã®ãƒ«ãƒ¼ãƒ«

#### âœ… ã‚„ã‚‹ã¹ãã“ã¨

1. **DTOã¯APIãƒ¬ã‚¹ãƒãƒ³ã‚¹/ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ§‹é€ ã‚’ãã®ã¾ã¾è¡¨ç¾**

   - `@JsonSerializable()` ã‚’ä½¿ç”¨
   - APIä»•æ§˜ã«å¿ å®Ÿãªãƒ‡ãƒ¼ã‚¿æ§‹é€ 

   ```dart
   // pokemon_detail_dto.dart
   import 'package:json_annotation/json_annotation.dart';

   part 'pokemon_detail_dto.g.dart';

   /// ãƒã‚±ãƒ¢ãƒ³è©³ç´°DTOï¼ˆAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰
   ///
   /// PokeAPI ã® /pokemon/{id} ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã€‚
   @JsonSerializable()
   class PokemonDetailDto {
     final int id;
     final String name;
     final int height;
     final int weight;
     final SpritesDto sprites;
     final List<TypeSlotDto> types;
     final List<StatSlotDto> stats;

     PokemonDetailDto({
       required this.id,
       required this.name,
       required this.height,
       required this.weight,
       required this.sprites,
       required this.types,
       required this.stats,
     });

     factory PokemonDetailDto.fromJson(Map<String, dynamic> json) =>
         _$PokemonDetailDtoFromJson(json);

     Map<String, dynamic> toJson() => _$PokemonDetailDtoToJson(this);
   }
   ```

2. **ãƒã‚¹ãƒˆã—ãŸæ§‹é€ ã‚‚DTOã¨ã—ã¦å®šç¾©**

   ```dart
   @JsonSerializable()
   class SpritesDto {
     final OtherSpritesDto? other;

     SpritesDto({this.other});

     factory SpritesDto.fromJson(Map<String, dynamic> json) =>
         _$SpritesDtoFromJson(json);
   }

   @JsonSerializable()
   class OtherSpritesDto {
     @JsonKey(name: 'official-artwork')
     final OfficialArtworkDto? officialArtwork;

     OtherSpritesDto({this.officialArtwork});

     factory OtherSpritesDto.fromJson(Map<String, dynamic> json) =>
         _$OtherSpritesDtoFromJson(json);
   }
   ```

#### âŒ ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨

- âŒ DTOã‚’ViewModelã‚„Viewã§ç›´æ¥ä½¿ç”¨ã™ã‚‹
- âŒ DTOã«ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ã
- âŒ DTOã‚’Entityã«å¤‰æ›ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’DTOå†…ã«æ›¸ãï¼ˆRepositoryã§å®Ÿæ–½ï¼‰

---

### Entity å±¤ã®ãƒ«ãƒ¼ãƒ«

#### âœ… ã‚„ã‚‹ã¹ãã“ã¨

1. **UIã«æœ€é©åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ **

   - Viewã¨ViewModelãŒä½¿ç”¨ã™ã‚‹
   - ä¸è¦ãªæƒ…å ±ã¯å«ã‚ãªã„
   - ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ï¼ˆä¸å¤‰ï¼‰ã«ã™ã‚‹

   ```dart
   // pokemon_entity.dart
   /// ãƒã‚±ãƒ¢ãƒ³è©³ç´°ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆãƒ“ãƒ¥ãƒ¼ç”¨ãƒ¢ãƒ‡ãƒ«ï¼‰
   ///
   /// DTOã‹ã‚‰å¤‰æ›ã•ã‚Œã¦ç”Ÿæˆã•ã‚Œã€UIã«æœ€é©åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æŒã¤ã€‚
   class Pokemon {
     final int id;
     final String name;
     final String imageUrl;       // DTOã‹ã‚‰æŠ½å‡ºãƒ»æ•´å½¢æ¸ˆã¿
     final List<String> types;    // DTOã‹ã‚‰æŠ½å‡ºãƒ»æ•´å½¢æ¸ˆã¿
     final int height;
     final int weight;
     final List<PokemonStat> stats; // DTOã‹ã‚‰æŠ½å‡ºãƒ»æ•´å½¢æ¸ˆã¿

     const Pokemon({
       required this.id,
       required this.name,
       required this.imageUrl,
       required this.types,
       required this.height,
       required this.weight,
       required this.stats,
     });
   }

   /// ãƒã‚±ãƒ¢ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
   class PokemonStat {
     final String name;
     final int value;

     const PokemonStat({
       required this.name,
       required this.value,
     });
   }
   ```

2. **ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ç”¨ã®Entityã‚’åˆ¥é€”å®šç¾©**

   ```dart
   // pokemon_list_item_entity.dart
   /// ãƒã‚±ãƒ¢ãƒ³ä¸€è¦§ã‚¢ã‚¤ãƒ†ãƒ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
   ///
   /// ä¸€è¦§è¡¨ç¤ºã«å¿…è¦ãªæœ€å°é™ã®æƒ…å ±ã®ã¿ã‚’æŒã¤ã€‚
   class PokemonListItem {
     final String name;
     final String url;

     const PokemonListItem({
       required this.name,
       required this.url,
     });

     /// URLã‹ã‚‰ãƒã‚±ãƒ¢ãƒ³IDã‚’æŠ½å‡º
     int get id {
       final segments = url.split('/');
       return int.parse(segments[segments.length - 2]);
     }
   }
   ```

#### âŒ ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨

- âŒ JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æŒã¤ï¼ˆDTOã®å½¹å‰²ï¼‰
- âŒ APIã®æ§‹é€ ã«ä¾å­˜ã™ã‚‹
- âŒ mutableï¼ˆå¯å¤‰ï¼‰ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¤

---

### Repository å±¤ã®ãƒ«ãƒ¼ãƒ«

#### âœ… ã‚„ã‚‹ã¹ãã“ã¨

1. **DTOâ†’Entityå¤‰æ›ã‚’æ‹…å½“**

   - ã“ã‚Œã¯Repositoryã®æœ€é‡è¦è²¬å‹™
   - ViewModelã«ã¯Entityã®ã¿ã‚’è¿”ã™

   ```dart
   // pokemon_repository.dart
   /// ãƒã‚±ãƒ¢ãƒ³ãƒªãƒã‚¸ãƒˆãƒª
   ///
   /// ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®æŠ½è±¡åŒ–ã¨DTOâ†’Entityå¤‰æ›ã‚’æ‹…å½“ã€‚
   /// ViewModelã«ã¯å¤‰æ›æ¸ˆã¿ã®Entityã‚’è¿”ã™ã€‚
   class PokemonRepository {
     final PokemonDataSource dataSource;

     PokemonRepository(this.dataSource);

     /// ãƒã‚±ãƒ¢ãƒ³ä¸€è¦§ã‚’å–å¾—ï¼ˆEntityã‚’è¿”ã™ï¼‰
     Future<List<PokemonListItem>> getPokemonList({
       required int limit,
       required int offset,
     }) async {
       final dto = await dataSource.getPokemonList(limit, offset);

       // DTOâ†’Entityå¤‰æ›ï¼ˆRepositoryã®è²¬å‹™ï¼‰
       return dto.results.map((item) {
         return PokemonListItem(
           name: item.name,
           url: item.url,
         );
       }).toList();
     }

     /// ãƒã‚±ãƒ¢ãƒ³è©³ç´°ã‚’å–å¾—ï¼ˆEntityã‚’è¿”ã™ï¼‰
     Future<Pokemon> getPokemonDetail(int id) async {
       final dto = await dataSource.getPokemonDetail(id);

       // è¤‡é›‘ãªå¤‰æ›å‡¦ç†ã‚‚Repositoryã§å®Ÿæ–½ï¼ˆRepositoryã®è²¬å‹™ï¼‰
       final imageUrl = dto.sprites.other?.officialArtwork?.frontDefault ??
           'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/$id.png';

       final types = dto.types
           .map((typeSlot) => typeSlot.type.name)
           .toList();

       final stats = dto.stats.map((statSlot) {
         return PokemonStat(
           name: statSlot.stat.name,
           value: statSlot.baseStat,
         );
       }).toList();

       return Pokemon(
         id: dto.id,
         name: dto.name,
         imageUrl: imageUrl,
         types: types,
         height: dto.height,
         weight: dto.weight,
         stats: stats,
       );
     }
   }
   ```

2. **è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’çµ±åˆ**

   ```dart
   // survey_repository.dart
   class SurveyRepository {
     final SurveyLocalDataSource _localDataSource;
     final SurveyRemoteDataSource _remoteDataSource;

     SurveyRepository(
       this._localDataSource,
       this._remoteDataSource,
     );

     /// ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ï¼ˆEntityã‚’å—ã‘å–ã‚‹ï¼‰
     Future<void> saveSurveyAnswer(SurveyAnswer answer) async {
       // Entityã‚’DTOã«å¤‰æ›ã—ã¦ã‹ã‚‰ä¿å­˜
       final dto = SurveyAnswerDto(
         favoriteType: answer.favoriteType,
         preferredSize: answer.preferredSize,
         personality: answer.personality,
         battleStyle: answer.battleStyle,
       );
       await _localDataSource.saveSurveyAnswer(dto);
     }

     /// ä¿å­˜ã•ã‚ŒãŸã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã‚’å–å¾—ï¼ˆEntityã‚’è¿”ã™ï¼‰
     Future<SurveyAnswer?> getSavedSurveyAnswer() async {
       final dto = await _localDataSource.getSavedSurveyAnswer();
       if (dto == null) return null;

       // DTOã‚’Entityã«å¤‰æ›
       return SurveyAnswer(
         favoriteType: dto.favoriteType,
         preferredSize: dto.preferredSize,
         personality: dto.personality,
         battleStyle: dto.battleStyle,
       );
     }

     /// ãŠã™ã™ã‚ã®ãƒã‚±ãƒ¢ãƒ³IDã‚’å–å¾—ï¼ˆEntityã‚’å—ã‘å–ã‚Šã€çµæœã‚’è¿”ã™ï¼‰
     Future<int> getRecommendedPokemonId(SurveyAnswer answer) async {
       // Entityã‚’DTOã«å¤‰æ›
       final dto = SurveyAnswerDto(
         favoriteType: answer.favoriteType,
         preferredSize: answer.preferredSize,
         personality: answer.personality,
         battleStyle: answer.battleStyle,
       );

       final response = await _remoteDataSource.getRecommendation(dto);
       return response.pokemonId;
     }
   }
   ```

3. **ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ä¸€éƒ¨ã‚’æ‹…å½“**

   - ãƒ‡ãƒ¼ã‚¿æ•´å½¢
   - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   - ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥
   - è¤‡æ•°ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®çµ±åˆãƒ­ã‚¸ãƒƒã‚¯

#### âŒ ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨

- âŒ DTOã‚’ãã®ã¾ã¾ViewModelã«è¿”ã™
- âŒ UIã«é–¢ã™ã‚‹å‡¦ç†ã‚’æ›¸ã
- âŒ ViewModelã®ã‚ˆã†ãªçŠ¶æ…‹ç®¡ç†ã‚’æŒã¤

---

### Presentation å±¤ã®ãƒ«ãƒ¼ãƒ«

#### âœ… ã‚„ã‚‹ã¹ãã“ã¨

1. **ViewModel ã¯ Riverpod Notifier ã§å®Ÿè£…**

   - `@riverpod` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
   - **ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ‹…å½“**ï¼ˆUseCaseã®ä»£ã‚ã‚Šï¼‰
   - çŠ¶æ…‹ç®¡ç†ã¯ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãª State ã‚¯ãƒ©ã‚¹

   ```dart
   // pokemon_list_view_model.dart
   import 'package:riverpod_annotation/riverpod_annotation.dart';
   import 'package:work/features/pokemon/entities/pokemon_list_item_entity.dart';
   import 'package:work/core/di/pokemon_di.dart';

   part 'pokemon_list_view_model.g.dart';

   /// ãƒã‚±ãƒ¢ãƒ³ä¸€è¦§ã®çŠ¶æ…‹
   class PokemonListState {
     final List<PokemonListItem> pokemons;
     final bool isLoading;
     final bool isLoadingMore;
     final bool hasMore;
     final String? errorMessage;

     const PokemonListState({
       this.pokemons = const [],
       this.isLoading = false,
       this.isLoadingMore = false,
       this.hasMore = true,
       this.errorMessage,
     });

     PokemonListState copyWith({
       List<PokemonListItem>? pokemons,
       bool? isLoading,
       bool? isLoadingMore,
       bool? hasMore,
       String? errorMessage,
     }) {
       return PokemonListState(
         pokemons: pokemons ?? this.pokemons,
         isLoading: isLoading ?? this.isLoading,
         isLoadingMore: isLoadingMore ?? this.isLoadingMore,
         hasMore: hasMore ?? this.hasMore,
         errorMessage: errorMessage ?? this.errorMessage,
       );
     }
   }

   @riverpod
   class PokemonListViewModel extends _$PokemonListViewModel {
     static const int _pageSize = 20;
     int _currentOffset = 0;

     @override
     PokemonListState build() {
       Future.microtask(() => loadInitialPokemons());
       return const PokemonListState(hasMore: true);
     }

     /// åˆå›ãƒ­ãƒ¼ãƒ‰
     Future<void> loadInitialPokemons() async {
       state = state.copyWith(isLoading: true, errorMessage: null);
       _currentOffset = 0;

       try {
         final repository = ref.read(pokemonRepositoryProvider);
         
         // Repositoryã‹ã‚‰å¤‰æ›æ¸ˆã¿ã®EntityãŒè¿”ã£ã¦ãã‚‹
         final pokemons = await repository.getPokemonList(
           limit: _pageSize,
           offset: _currentOffset,
         );

         state = state.copyWith(
           pokemons: pokemons,
           isLoading: false,
           hasMore: pokemons.length == _pageSize,
         );
         _currentOffset += _pageSize;
       } catch (e) {
         state = state.copyWith(
           isLoading: false,
           errorMessage: 'ãƒã‚±ãƒ¢ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: $e',
         );
       }
     }

     /// è¿½åŠ èª­ã¿è¾¼ã¿
     Future<void> loadMorePokemons() async {
       if (state.isLoadingMore || !state.hasMore) return;

       state = state.copyWith(isLoadingMore: true);

       try {
         final repository = ref.read(pokemonRepositoryProvider);
         final newPokemons = await repository.getPokemonList(
           limit: _pageSize,
           offset: _currentOffset,
         );

         state = state.copyWith(
           pokemons: [...state.pokemons, ...newPokemons],
           isLoadingMore: false,
           hasMore: newPokemons.length == _pageSize,
         );
         _currentOffset += _pageSize;
       } catch (e) {
         state = state.copyWith(
           isLoadingMore: false,
           errorMessage: 'ãƒã‚±ãƒ¢ãƒ³ã®è¿½åŠ èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: $e',
         );
       }
     }
   }
   ```

2. **State ã‚¯ãƒ©ã‚¹ã¯ `copyWith` ã‚’å®Ÿè£…**

   - ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªçŠ¶æ…‹æ›´æ–°ã®ãŸã‚
   - nullable ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚é©åˆ‡ã«æ‰±ã†

3. **View ã¯ ConsumerWidget ã¾ãŸã¯ HookConsumerWidget**

   - UIã®æç”»ã®ã¿ã‚’æ‹…å½“
   - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯æ›¸ã‹ãªã„

   ```dart
   // pokemon_list_view.dart
   class PokemonListView extends HookConsumerWidget {
     const PokemonListView({super.key});

     @override
     Widget build(BuildContext context, WidgetRef ref) {
       final state = ref.watch(pokemonListViewModelProvider);
       final viewModel = ref.read(pokemonListViewModelProvider.notifier);

       // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç›£è¦–
       final scrollController = useScrollController();
       useEffect(() {
         void onScroll() {
           if (scrollController.position.pixels >=
               scrollController.position.maxScrollExtent * 0.9) {
             viewModel.loadMorePokemons();
           }
         }
         scrollController.addListener(onScroll);
         return () => scrollController.removeListener(onScroll);
       }, [scrollController]);

       return Scaffold(
         appBar: AppBar(title: const Text('ãƒã‚±ãƒ¢ãƒ³å›³é‘‘')),
         body: state.isLoading
             ? const Center(child: CircularProgressIndicator())
             : ListView.builder(
                 controller: scrollController,
                 itemCount: state.pokemons.length + (state.hasMore ? 1 : 0),
                 itemBuilder: (context, index) {
                   // UIå®Ÿè£…...
                 },
               ),
       );
     }
   }
   ```

#### âŒ ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨

- âŒ View ã‹ã‚‰ç›´æ¥ Repository ã‚„ DataSource ã‚’å‘¼ã¶
- âŒ ViewModel ã§ç›´æ¥ DataSource ã‚’å‘¼ã¶ï¼ˆRepositoryã‚’çµŒç”±ï¼‰
- âŒ State ã‚’ç›´æ¥å¤‰æ›´ã™ã‚‹ï¼ˆå¿…ãš `copyWith` ã‚’ä½¿ã†ï¼‰
- âŒ ViewModel ã« UI ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆè‰²ã€ã‚µã‚¤ã‚ºãªã©ï¼‰ã‚’æ›¸ã

---

## ä¾å­˜æ€§æ³¨å…¥ï¼ˆDIï¼‰ã®ãƒ«ãƒ¼ãƒ«

### DI ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®

å…¨ã¦ã® DI è¨­å®šã¯ `lib/core/di/` ã«é›†ç´„ï¼š

```dart
// lib/core/di/pokemon_di.dart
import 'package:riverpod_annotation/riverpod_annotation.dart';
import 'package:work/features/pokemon/datasources/pokemon_data_source.dart';
import 'package:work/features/pokemon/pokemon_repository.dart';
import 'package:work/core/network/dio_client.dart';

part 'pokemon_di.g.dart';

/// ========================================
/// Pokemon - Dependency Injection
/// ========================================

/// PokemonApiClientãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
@riverpod
PokemonDataSource pokemonDataSource(PokemonDataSourceRef ref) {
  final dio = ref.watch(dioProvider);
  return PokemonDataSource(dio);
}

/// PokemonRepositoryãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
@riverpod
PokemonRepository pokemonRepository(PokemonRepositoryRef ref) {
  final dataSource = ref.watch(pokemonDataSourceProvider);
  return PokemonRepository(dataSource);
}
```

### DI ã®ä¾å­˜é–¢ä¿‚

```
Dio â†’ DataSource â†’ Repository â†’ ViewModel
```

å„å±¤ã¯ 1 ã¤ä¸‹ã®å±¤ã®ã¿ã«ä¾å­˜ã™ã‚‹ã€‚

### å…±é€šã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼

å…±é€šã§ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¯ `core/network/` ãªã©ã«é…ç½®ï¼š

```dart
// lib/core/network/dio_client.dart
import 'package:dio/dio.dart';
import 'package:riverpod_annotation/riverpod_annotation.dart';

part 'dio_client.g.dart';

@riverpod
Dio dio(DioRef ref) {
  final dio = Dio(BaseOptions(
    connectTimeout: const Duration(seconds: 30),
    receiveTimeout: const Duration(seconds: 30),
  ));

  // ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼ãªã©ã®è¨­å®š
  dio.interceptors.add(LogInterceptor(
    requestBody: true,
    responseBody: true,
  ));

  return dio;
}
```

---

## å‘½åè¦å‰‡

### ãƒ•ã‚¡ã‚¤ãƒ«å

- **ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹** ã‚’ä½¿ç”¨
- æœ«å°¾ã®è¦å‰‡ã‚’å³å®ˆ

| ç¨®é¡ | å‘½åè¦å‰‡ | ä¾‹ |
|------|---------|-----|
| DataSource | `<feature>_data_source.dart` | `pokemon_data_source.dart` |
| DTO | `<model>_dto.dart` | `pokemon_detail_dto.dart` |
| Entity | `<model>_entity.dart` | `pokemon_entity.dart` |
| Repository | `<feature>_repository.dart` | `pokemon_repository.dart` |
| View | `<feature>_view.dart` | `pokemon_list_view.dart` |
| ViewModel | `<feature>_view_model.dart` | `pokemon_list_view_model.dart` |
| State | `<feature>_state.dart` | `pokemon_list_state.dart` |

### ã‚¯ãƒ©ã‚¹å

| ç¨®é¡ | å‘½åè¦å‰‡ | ä¾‹ |
|------|---------|-----|
| DataSource | `<Feature>DataSource` | `PokemonDataSource` |
| DTO | `<ModelName>Dto` | `PokemonDetailDto` |
| Entity | `<ModelName>` | `Pokemon`, `PokemonListItem` |
| Repository | `<Feature>Repository` | `PokemonRepository` |
| ViewModel | `<Feature>ViewModel` | `PokemonListViewModel` |
| View | `<Feature>View` | `PokemonListView` |
| State | `<Feature>State` | `PokemonListState` |

---

## ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„

### Import ã®é †åº

1. Dart SDK
2. Flutter SDK
3. å¤–éƒ¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
4. è‡ªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

```dart
import 'dart:async';

import 'package:flutter/material.dart';

import 'package:riverpod_annotation/riverpod_annotation.dart';
import 'package:dio/dio.dart';

import 'package:work/core/di/pokemon_di.dart';
import 'package:work/features/pokemon/entities/pokemon_entity.dart';
```

### ã‚³ãƒ¡ãƒ³ãƒˆ

- ã‚¯ãƒ©ã‚¹ã«ã¯å¿…ãšãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ`///`ï¼‰ã‚’æ›¸ã
- è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã«ã¯èª¬æ˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã
- DTOãƒ»Entityãƒ»Repositoryã«ã¯å½¹å‰²ã‚’æ˜è¨˜

```dart
/// ãƒã‚±ãƒ¢ãƒ³è©³ç´°DTOï¼ˆAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰
///
/// PokeAPI ã® /pokemon/{id} ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã€‚
/// ã“ã®DTOã¯Repositoryã§Entityã«å¤‰æ›ã•ã‚Œã‚‹ã€‚
@JsonSerializable()
class PokemonDetailDto {
  // ...
}

/// ãƒã‚±ãƒ¢ãƒ³è©³ç´°ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆãƒ“ãƒ¥ãƒ¼ç”¨ãƒ¢ãƒ‡ãƒ«ï¼‰
///
/// DTOã‹ã‚‰å¤‰æ›ã•ã‚Œã¦ç”Ÿæˆã•ã‚Œã€UIã«æœ€é©åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æŒã¤ã€‚
class Pokemon {
  // ...
}

/// ãƒã‚±ãƒ¢ãƒ³ãƒªãƒã‚¸ãƒˆãƒª
///
/// ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®æŠ½è±¡åŒ–ã¨DTOâ†’Entityå¤‰æ›ã‚’æ‹…å½“ã€‚
/// ViewModelã«ã¯å¤‰æ›æ¸ˆã¿ã®Entityã‚’è¿”ã™ã€‚
class PokemonRepository {
  // ...
}
```

### ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¿…ãšã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’å®Ÿè¡Œï¼š

```bash
fvm flutter pub run build_runner build --delete-conflicting-outputs
```

- `@JsonSerializable()` ã‚’ä½¿ã£ãŸ DTO
- `@riverpod` ã‚’ä½¿ã£ãŸ Provider
- `@RestApi()` ã‚’ä½¿ã£ãŸ DataSource

---

## ç¦æ­¢äº‹é …

### ğŸš« çµ¶å¯¾ã«ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨

1. **å±¤ã‚’ã¾ãŸã„ã ä¸é©åˆ‡ãªä¾å­˜**

   - âŒ ViewModel ã‹ã‚‰ DataSource ã‚’ç›´æ¥å‘¼ã¶ï¼ˆRepositoryã‚’çµŒç”±ï¼‰
   - âŒ View ã‹ã‚‰ Repository ã‚’ç›´æ¥å‘¼ã¶ï¼ˆViewModelã‚’çµŒç”±ï¼‰
   - âŒ Repository ã‹ã‚‰ ViewModel ã‚’å‚ç…§

2. **DTOã¨Entityã®æ··åŒ**

   - âŒ DTOã‚’ViewModelã‚„Viewã§ä½¿ç”¨
   - âŒ Entityã«JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æŒãŸã›ã‚‹
   - âŒ RepositoryãŒDTOã‚’è¿”ã™

3. **å¾ªç’°å‚ç…§**

   - âŒ A ãŒ B ã«ä¾å­˜ã—ã€B ãŒ A ã«ä¾å­˜ã™ã‚‹

4. **ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®ä½¿ç”¨**

   - âŒ `static` ãªã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
   - âœ… Riverpodã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½¿ç”¨

5. **ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°**

   - âŒ URL ã‚„ã‚­ãƒ¼ã‚’ç›´æ¥ã‚³ãƒ¼ãƒ‰ã«æ›¸ã
   - âœ… ç’°å¢ƒå¤‰æ•°ã‚„å®šæ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨

6. **å·¨å¤§ãªãƒ•ã‚¡ã‚¤ãƒ«**

   - âŒ 1 ãƒ•ã‚¡ã‚¤ãƒ«ã«è¤‡æ•°ã®è²¬å‹™ã‚’æŒã¤ã‚¯ãƒ©ã‚¹ã‚’è©°ã‚è¾¼ã‚€
   - âœ… 1 ãƒ•ã‚¡ã‚¤ãƒ« = 1 ã‚¯ãƒ©ã‚¹ï¼ˆState ã‚¯ãƒ©ã‚¹ãªã©ã®å°è¦æ¨¡ã‚¯ãƒ©ã‚¹ã¯ä¾‹å¤–ï¼‰

7. **State ã®ç›´æ¥å¤‰æ›´**
   - âŒ `state.pokemons.add(newPokemon)` ã®ã‚ˆã†ãªå¤‰æ›´
   - âœ… `state = state.copyWith(pokemons: [...state.pokemons, newPokemon])`

---

## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### æ–°æ©Ÿèƒ½å®Ÿè£…æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
- [ ] `datasources/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ãŸã‹ï¼Ÿ
- [ ] `dto/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ãŸã‹ï¼Ÿ
- [ ] `entities/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ãŸã‹ï¼Ÿ
- [ ] `presentation/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ãŸã‹ï¼Ÿ
- [ ] Repository ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ãŸã‹ï¼Ÿ

#### å‘½åè¦å‰‡
- [ ] DataSource: `*_data_source.dart` / `*DataSource`
- [ ] DTO: `*_dto.dart` / `*Dto`
- [ ] Entity: `*_entity.dart` / `*`
- [ ] Repository: `*_repository.dart` / `*Repository`
- [ ] View: `*_view.dart` / `*View`
- [ ] ViewModel: `*_view_model.dart` / `*ViewModel`

#### å®Ÿè£…å†…å®¹
- [ ] DTO ã« `@JsonSerializable()` ã‚’ä»˜ã‘ãŸã‹ï¼Ÿ
- [ ] Entity ã¯ UI ã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
- [ ] Repository ã¯ DTO â†’ Entity å¤‰æ›ã—ã¦ã„ã‚‹ã‹ï¼Ÿ
- [ ] Repository ã¯ Entity ã®ã¿ã‚’è¿”ã—ã¦ã„ã‚‹ã‹ï¼Ÿ
- [ ] ViewModel ã¯ Riverpod Notifier ã§å®Ÿè£…ã—ãŸã‹ï¼Ÿ
- [ ] State ã‚¯ãƒ©ã‚¹ã« `copyWith` ã‚’å®Ÿè£…ã—ãŸã‹ï¼Ÿ
- [ ] View ã¯ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’æŒã£ã¦ã„ãªã„ã‹ï¼Ÿ

#### DIè¨­å®š
- [ ] DI è¨­å®šã‚’ `core/di/<feature>_di.dart` ã«è¿½åŠ ã—ãŸã‹ï¼Ÿ
- [ ] DataSource â†’ Repository â†’ ViewModel ã®ä¾å­˜é–¢ä¿‚ã¯æ­£ã—ã„ã‹ï¼Ÿ

#### ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ»å“è³ª
- [ ] `build_runner` ã‚’å®Ÿè¡Œã—ãŸã‹ï¼Ÿ
- [ ] `flutter analyze` ã§ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ï¼Ÿ
- [ ] é©åˆ‡ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ãŸã‹ï¼Ÿ
- [ ] Import ã®é †åºã¯æ­£ã—ã„ã‹ï¼Ÿ

---

## ã‚ˆãã‚ã‚‹å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³

```dart
@riverpod
class ListViewModel extends _$ListViewModel {
  int _offset = 0;
  static const int _limit = 20;

  @override
  ListState build() {
    Future.microtask(() => loadInitial());
    return const ListState();
  }

  Future<void> loadInitial() async {
    _offset = 0;
    state = state.copyWith(isLoading: true);
    
    try {
      final items = await ref.read(repositoryProvider).getList(
        limit: _limit,
        offset: _offset,
      );
      
      state = state.copyWith(
        items: items,
        isLoading: false,
        hasMore: items.length == _limit,
      );
      _offset += _limit;
    } catch (e) {
      state = state.copyWith(
        isLoading: false,
        errorMessage: 'ã‚¨ãƒ©ãƒ¼: $e',
      );
    }
  }

  Future<void> loadMore() async {
    if (state.isLoadingMore || !state.hasMore) return;
    
    state = state.copyWith(isLoadingMore: true);
    
    try {
      final items = await ref.read(repositoryProvider).getList(
        limit: _limit,
        offset: _offset,
      );
      
      state = state.copyWith(
        items: [...state.items, ...items],
        isLoadingMore: false,
        hasMore: items.length == _limit,
      );
      _offset += _limit;
    } catch (e) {
      state = state.copyWith(isLoadingMore: false);
    }
  }
}
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: è¤‡æ•°ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®çµ±åˆ

```dart
class CachedRepository {
  final RemoteDataSource _remote;
  final LocalDataSource _local;

  CachedRepository(this._remote, this._local);

  Future<Item> getItem(int id) async {
    // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç¢ºèª
    final cached = await _local.getItem(id);
    if (cached != null && !_isExpired(cached)) {
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ãªã‚‰Entityã«å¤‰æ›ã—ã¦è¿”ã™
      return _dtoToEntity(cached);
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„ã‹æœŸé™åˆ‡ã‚Œãªã‚‰ãƒªãƒ¢ãƒ¼ãƒˆã‹ã‚‰å–å¾—
    final dto = await _remote.getItem(id);
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    await _local.saveItem(dto);
    
    // Entityã«å¤‰æ›ã—ã¦è¿”ã™
    return _dtoToEntity(dto);
  }

  bool _isExpired(ItemDto dto) {
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
    return DateTime.now().difference(dto.cachedAt) > const Duration(hours: 1);
  }

  Item _dtoToEntity(ItemDto dto) {
    // DTOâ†’Entityå¤‰æ›
    return Item(
      id: dto.id,
      name: dto.name,
      // ...
    );
  }
}
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡

```dart
@riverpod
class FormViewModel extends _$FormViewModel {
  @override
  FormState build() => const FormState();

  Future<void> submit(FormData data) async {
    if (!_validate(data)) {
      state = state.copyWith(errorMessage: 'ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼');
      return;
    }

    state = state.copyWith(isSubmitting: true, errorMessage: null);

    try {
      // Entityã‹ã‚‰DTOã«å¤‰æ›ã—ã¦RepositoryçµŒç”±ã§é€ä¿¡
      await ref.read(repositoryProvider).submitForm(data);
      
      state = state.copyWith(
        isSubmitting: false,
        isSuccess: true,
      );
    } catch (e) {
      state = state.copyWith(
        isSubmitting: false,
        errorMessage: 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: $e',
      );
    }
  }

  bool _validate(FormData data) {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
    return data.name.isNotEmpty && data.email.contains('@');
  }
}
```

---

## å‚è€ƒè³‡æ–™

- [Clean Architecture (Uncle Bob)](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
- [Riverpod Documentation](https://riverpod.dev/)
- [Retrofit Documentation](https://pub.dev/packages/retrofit)
- [json_serializable Documentation](https://pub.dev/packages/json_serializable)

---
